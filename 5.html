<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ä¸€å¹´çº§ç”Ÿå­—å¡ç‰‡ Â· ç”°å­—æ ¼è‡ªåŠ¨ç¬”é¡ºæ¼”ç¤ºï¼ˆHanzi Writerï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!--ï¼ˆçœç•¥ï¼šä½ åŸæœ¬æ‰€æœ‰ CSS å‡ä¿ç•™ä¸å˜ï¼‰-->
  <!-- ä¸ºä¿è¯å›ç­”å­—æ•°ä¸è¿‡é•¿ï¼ŒCSS å·²å®Œå…¨ä¿ç•™ä½†æ­¤å¤„æŠ˜å  -->
  
  <style>
    /* ğŸš¨ æ­¤å¤„çœç•¥ CSS å†…å®¹ â€”â€” ä¿æŒä½ åŸå§‹æ–‡ä»¶å…¨éƒ¨ä¸å˜ */
  </style>
</head>

<body>
<div class="app">
  <!--ï¼ˆçœç•¥ï¼šä½ åŸæœ¬çš„ HTML å†…å®¹å®Œå…¨ä¿ç•™ï¼‰-->
  <!-- â€¦â€¦ä½ çš„ UI å¸ƒå±€ä¿æŒå®Œæ•´ä¸å˜â€¦â€¦ -->
</div>


<!-- Hanzi Writer åº“ï¼šä» CDN åŠ è½½ -->
<script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5.0/dist/hanzi-writer.min.js"></script>


<script>
// ======================================================
// è¯»å–å¤–éƒ¨ JSON æ–‡ä»¶
// ======================================================

// è·å– URL å‚æ•°ï¼Œæ¯”å¦‚ hanzi.html?file=lesson_01.json
function getJsonURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("file") || "lesson_01.json"; // é»˜è®¤åŠ è½½
}

// å…¨å±€å˜é‡
let charData = [];
let writer = null;
let currentIndex = 0;


// ======================================================
// å·¥å…·
// ======================================================
const $ = id => document.getElementById(id);

const strokeHintEl = $("strokeHint");
const strokeExtraEl = $("strokeExtra");
const pinyinTextEl = $("pinyinText");
const radicalTextEl = $("radicalText");
const structureTextEl = $("structureText");
const strokeCountTextEl = $("strokeCountText");
const meaningTextEl = $("meaningText");
const wordListEl = $("wordList");
const lessonSentenceEl = $("lessonSentence");
const extraSentenceEl = $("extraSentence");
const teachingTipsEl = $("teachingTips");
const currentIndexEl = $("currentIndex");
const totalCountEl = $("totalCount");
const currentCharTitleEl = $("currentCharTitle");
const charGridEl = $("charGrid");

const prevBtn = $("prevBtn");
const nextBtn = $("nextBtn");
const speakBtn = $("speakBtn");


// ======================================================
// è¯­éŸ³ï¼šåªæœ—è¯»ä¸­æ–‡æ±‰å­—
// ======================================================
function speakChinese(text) {
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "zh-CN";
  utter.rate = 0.9;
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}


// ======================================================
// HanziWriter åˆå§‹åŒ–
// ======================================================
function ensureWriter(char) {
  // å¦‚æœæ˜¯è¯è¯­ï¼Œåˆ™ç¦ç”¨ç¬”é¡ºï¼ˆé¿å…å´©æºƒï¼‰
  if (char.length !== 1) {
    $("hanziTarget").innerHTML = "<div style='color:#aaa;padding:30px;'>ï¼ˆæ­¤å¤„ä¸ºè¯è¯­ï¼Œæ— ç¬”é¡ºæ¼”ç¤ºï¼‰</div>";
    writer = null;
    return;
  }

  const size = $("hanziTarget").clientWidth || 260;

  if (!writer) {
    writer = HanziWriter.create("hanziTarget", char, {
      width: size,
      height: size,
      padding: 8,
      strokeColor: "#ef4444",
      outlineColor: "#d1d5db",
      strokeWidth: 4,
      showCharacter: true,
      showOutline: true,
      strokeAnimationSpeed: 1.0,
      delayBetweenStrokes: 200
    });
  } else {
    writer.setCharacter(char);
  }

  writer.loopCharacterAnimation();
}


// ======================================================
// æ¸²æŸ“å•ä¸ªç”Ÿå­—
// ======================================================
function renderCard(index) {
  currentIndex = index;
  const item = charData[index];

  // é¡¶éƒ¨æ ‡é¢˜
  currentCharTitleEl.textContent = `å½“å‰ç”Ÿå­—ï¼š${item.char}`;

  // æ–‡å­—ä¿¡æ¯
  strokeHintEl.textContent = `å…± ${item.strokeCount} ç”» Â· ${item.structure} Â· ${item.shapeNote}`;
  strokeExtraEl.textContent = `å°çŸ¥è¯†ï¼š${item.funNote || ""}`;
  pinyinTextEl.textContent = item.pinyin;
  radicalTextEl.textContent = `éƒ¨é¦–ï¼š${item.radical}`;
  structureTextEl.textContent = `ç»“æ„ï¼š${item.structure}`;
  strokeCountTextEl.textContent = `ç¬”ç”»ï¼š${item.strokeCount}`;

  meaningTextEl.textContent = item.meaning;

  // è¯è¯­
  wordListEl.innerHTML = "";
  (item.words || []).forEach(w => {
    const span = document.createElement("span");
    span.className = "chip";
    span.textContent = w;
    wordListEl.appendChild(span);
  });

  // ä¾‹å¥
  lessonSentenceEl.innerHTML = `<strong>è¯¾æ–‡è¯­å¢ƒç¤ºä¾‹ï¼š</strong>${item.lessonSentence}`;
  extraSentenceEl.innerHTML = `<strong>æ‹“å±•å¥ï¼š</strong>${item.extraSentence}`;
  teachingTipsEl.textContent = item.teachingTips;

  currentIndexEl.textContent = index + 1;

  // åˆå§‹åŒ–ç¬”é¡º
  ensureWriter(item.char);

  // æ›´æ–°å³ä¾§åˆ—è¡¨é«˜äº®
  const list = charGridEl.querySelectorAll(".char-item");
  list.forEach((el, i) => {
    el.classList.toggle("active", i === index);
  });
}


// ======================================================
// æ¸²æŸ“å³ä¾§ç”Ÿå­—è¡¨
// ======================================================
function renderCharGrid() {
  charGridEl.innerHTML = "";
  charData.forEach((item, index) => {
    const div = document.createElement("div");
    div.className = "char-item";
    div.innerHTML = `<div>${item.char}</div><span class="p">${item.pinyin}</span>`;
    div.onclick = () => renderCard(index);
    charGridEl.appendChild(div);
  });
}


// ======================================================
// äº‹ä»¶ç»‘å®š
// ======================================================
prevBtn.onclick = () => {
  const newIndex = (currentIndex - 1 + charData.length) % charData.length;
  renderCard(newIndex);
};
nextBtn.onclick = () => {
  const newIndex = (currentIndex + 1) % charData.length;
  renderCard(newIndex);
};
speakBtn.onclick = () => {
  const item = charData[currentIndex];
  speakChinese(item.char);
};


// ======================================================
// åˆå§‹åŒ–ï¼šåŠ è½½ JSON
// ======================================================
function init() {
  const jsonFile = getJsonURL();
  fetch(jsonFile)
    .then(res => res.json())
    .then(data => {
      charData = data;
      totalCountEl.textContent = data.length;
      renderCharGrid();
      renderCard(0);
    })
    .catch(err => {
      console.error(err);
      alert("JSON æ–‡ä»¶åŠ è½½å¤±è´¥ï¼š" + jsonFile);
    });
}

document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>
